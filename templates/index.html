<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CHIP-8 Online Emulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    canvas { image-rendering: pixelated; image-rendering: crisp-edges; }
    .retro-font { font-family: 'Orbitron', monospace; }
    .pixel-on { filter: brightness(1.2); }
  </style>
</head>
<body class="h-full flex flex-col">

  <!-- Navbar -->
  <nav class="bg-black border-b border-green-500 px-4 py-3 flex items-center justify-between shadow-lg">
    <div class="flex items-center space-x-3">
      <img src="https://api.iconify.design/mdi:chip.svg?color=%234ade80" alt="CHIP-8" class="w-8 h-8">
      <h1 class="text-xl retro-font text-green-400">CHIP-8 Online</h1>
    </div>
    <div class="flex items-center space-x-4">
      <span id="counter" class="text-sm bg-gray-800 px-3 py-1 rounded-full border border-green-600">
        Loading...
      </span>
    </div>
  </nav>

  <div class="flex-1 container mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl">
    
    <!-- Emulator Screen -->
    <div class="lg:col-span-2 bg-black rounded-xl shadow-2xl p-4 border border-green-700">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg retro-font text-green-400">Display</h2><button id="pause" class="px-3 py-1 text-s bg-green-600 hover:bg-green-500 rounded text-black retro-font">Pause</button>
        <div class="text-xs text-gray-400">
          <span id="fps">FPS: --</span> | <span id="cpr">CPR: --</span>
        </div>
      </div>
      <div class="bg-gray-950 rounded-lg overflow-hidden border-4 border-gray-800">
        <canvas id="screen" width="640" height="320" class="w-full h-auto max-w-full"></canvas>
      </div>
      <p class="text-xs text-gray-500 mt-2 text-center">Use 1-4, Q-R, A-F, Z-V keys</p>
    </div>

    <!-- ROM Selector -->
    <div class="bg-gray-800 rounded-xl shadow-xl p-5 border border-green-900 overflow-y-auto max-h-screen">
      <h2 class="text-lg retro-font text-green-400 mb-4">Games</h2>
      <div id="roms" class="space-y-3"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const SCALE = 10;
    const COL_ON = "#10b981";
    const COL_OFF = "#111827";
    const canvas = document.getElementById("screen");
    const ctx = canvas.getContext("2d");
    const ws = new WebSocket(`ws://${location.host}/ws`);
    
    let session_id = null;
    let currentRom = null;
    let fpsCounter = 0;
    let lastFrameTime = performance.now();

    // Render frame
    function renderFrame(frame) {
      ctx.fillStyle = COL_OFF;
      ctx.fillRect(0, 0, 64 * SCALE, 32 * SCALE);
      ctx.fillStyle = COL_ON;
      for (let i = 0; i < frame.length; i++) {
        if (frame[i] === 1) {
          const x = (i % 64) * SCALE;
          const y = Math.floor(i / 64) * SCALE;
          ctx.fillRect(x, y, SCALE, SCALE);
        }
      }

      // FPS
      const now = performance.now();
      fpsCounter++;
      if (now - lastFrameTime >= 1000) {
        document.getElementById("fps").textContent = `FPS: ${fpsCounter}`;
        fpsCounter = 0;
        lastFrameTime = now;
      }
    }

    // WebSocket
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.session_id) {
        session_id = data.session_id;
        loadRoms();
        updateStats();
        return;
      }

      if (data.frame) {
        renderFrame(data.frame);
        if (data.fps !== undefined) document.getElementById("fps").textContent = `FPS: ${data.fps}`;
        if (data.cpr !== undefined) document.getElementById("cpr").textContent = `CPR: ${data.cpr}`;
      }
    };

    // Load ROMs
    async function loadRoms() {
      const res = await fetch("/roms");
      const roms = await res.json();
      const container = document.getElementById("roms");
      container.innerHTML = "";

      Object.entries(roms).forEach(([name, info]) => {
        const card = document.createElement("div");
        card.className = "bg-gray-700 rounded-lg p-3 border border-gray-600 hover:border-green-500 transition-all";
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold text-green-300">${name}</h3>
              <p class="text-xs text-gray-400 mt-1">${info.desc}</p>
            </div>
            <button 
              class="px-3 py-1 text-xs bg-green-600 hover:bg-green-500 rounded text-black font-bold transition"
              onclick="switchRom('${name}')">
              ${currentRom === name ? 'Running' : 'Play'}
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Switch ROM
    async function switchRom(rom) {
      if (!session_id) return;
      await fetch(`/change_rom/${rom}/${session_id}`, { method: "POST" });
      currentRom = rom;
      loadRoms(); // refresh buttons
    }

    // Stats
    async function updateStats() {
      try {
        const res = await fetch("/stats");
        const data = await res.json();
        document.getElementById("counter").innerHTML = `
          <span class="text-green-400">${data.current_sessions}</span> / 
          <span class="text-gray-400">${data.total_sessions}</span> online
        `;
      } catch (e) {
        document.getElementById("counter").textContent = "Offline";
      }
    }

    // Key mapping
    const keymap = {
      "1": 0x1, "2": 0x2, "3": 0x3, "4": 0xC,
      "q": 0x4, "w": 0x5, "e": 0x6, "r": 0xD,
      "a": 0x7, "s": 0x8, "d": 0x9, "f": 0xE,
      "z": 0xA, "x": 0x0, "c": 0xB, "v": 0xF
    };

    pauseButton = document.getElementById("pause")
    pauseButton.addEventListener("click", e => {
      if (pauseButton.innerText == "Pause") {pauseButton.innerText = "Unpause";}
      else {pauseButton.innerText = "Pause"}
        fetch(
          `/pause/${session_id}`, {method: "POST"}
        );
      });

    window.addEventListener("keydown", e => {
      if (keymap[e.key] !== undefined && !e.repeat) {
        ws.send(JSON.stringify({ key: keymap[e.key], pressed: true }));
      }
    });

    window.addEventListener("keyup", e => {
      if (keymap[e.key] !== undefined) {
        ws.send(JSON.stringify({ key: keymap[e.key], pressed: false }));
      }
    });

    // Periodic updates
    setInterval(updateStats, 10000);
    updateStats();
  </script>
</body>
</html>